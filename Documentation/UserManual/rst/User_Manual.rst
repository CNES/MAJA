User manual
===========

This chapter describes the user manual for the MAJA chains.

User account and permission
---------------------------

The user needs at least read and execution rights within the MAJA
install directory (see :ref:`installation:package installation`).

Launching MAJA processing
-------------------------

MAJA is launched in command line in two possible ways (example for
“/opt” installation directory):

-  Providing the JobOrder file as argument of the command line:

.. code::
   
   $ /<path to maja installation dir>/bin/maja --jobOrder
   ./myJobOrder.xml


The JobOrder file details the processing mode, the access path to all
the inputs (images, GIPP, DTM, meteo data) and to the configuration
files, the access path to the directory containing all the output
produced by MAJA.

   Note: the possible values for the <Processor_Name> node are:

-  MAJA_L2_INIT_CHAIN

-  MAJA_L2_NOMINAL_CHAIN

-  MAJA_L2_BACKWARD_CHAIN

   An example of Job Order file is provided in [AD01]_.

-  Providing all the processing details (processing mode, input data
   directory, output directory, etc) as arguments of the command line:
  
.. code::
   
   $ /<path to maja installation dir>/bin/maja

   $ --mode L2INIT # Processing mode

   $ --input ./Input/Images # Input data directory

   $ --conf ./Input/Conf # User configuration files directory$

   $ --TileId “ID” # TileId, only necessary for PSD13 Sentinel2 products

   $ --output ./WorkingDir # Output working directory


The user can obtain the help to launch MAJA processing executing the
following command line:

.. code::
   
   $ /<path to maja installation dir>/maja --help

This command produces the helper lines detailed in Annex A

Additional details about the processing mode, the inputs expected by
MAJA and the outputs produced are provided in the following paragraphs.

Interfaces of MAJA chains
-------------------------

MAJA Processing modes
~~~~~~~~~~~~~~~~~~~~~

The level 2 chain implements successively several different algorithms
such as atmospheric correction, cloud and snow detection or slope and
environment correction in order to generate level 2 products. Some of
those algorithms are multi temporal, therefore the chain uses level-2
product of date D-1 (the last available level 2 product) to generate the
level 2 product of date D.

An initialization process for the first product of a time series has
been developed (*Init mode*); in this mode the product is generated with
a priori values and is just used to start a new time series. This first
level 2 product of date D is then used to generate the product of date
D+1 in *nominal mode* and so on for all the time series of level 1
products.

.. image:: ./Art/Init_Nominal_Mode.png

The level 2 product generated in init mode are usually of inferior
quality. In order to avoid the former, the *backward mode* has been
added in MAJA. This mode is used to improve the quality of the first
level 2 product of a time series. The L1 products are processed from the
youngest (date D+N) back to the oldest (date D).

In this mode the youngest L1 product (D+N) is processed in init mode.
The older L1 products of the time series (D+i) are then processed in
nominal mode using the level 2 product of date D+i+1 as input and so on
backward to the oldest ones (D). The oldest level 2 product of date D is
then used as input to reprocess all the products of the time series from
the oldest to the youngest one in *nominal mode*.

.. image:: ./Art/BackWardMode.png

MAJA allows seven different processing modes:

-  Level-2 products generation:

   -  Init Mode

   -  Backward Mode

   -  Nominal Mode

Processing Interfaces
~~~~~~~~~~~~~~~~~~~~~

The following figures show MAJA inputs and outputs for all the
processing modes.

In particular, the input products for the Level-2 processing are:

-  1 Level-1 product for the Init Mode

-  N Level-1 products for the Backward Mode

-  1 Level-1 product and 1 Level-2 product for the Nominal Mode.


.. image:: ./Art/NominalDetail.png

When MAJA is launched, all the input data shall be available in the
input directory:

-  L1, L2 image product (according to the processing mode),

-  DTM data covering the tile (see section :ref:`user_manual:auxiliary data of maja`)

-  Meteo data applicable for the acquisition date of EACH L1C product
   (see section :ref:`user_manual:auxiliary data of maja`)

-  Production parameters: GIPP applicable for the acquisition date of
   EACH L1C product (see section :ref:`user_manual:gipps files of maja`)

   The output data generated by MAJA will all be in the specified output
   directory:

-  L2 Image product and/or quicklook

   Additional details on the Inputs and Outputs are provided in :ref:`user_manual:the products`, :ref:`user_manual:auxiliary data of maja`
   and :ref:`user_manual:gipps files of maja`.

Operational Interfaces
~~~~~~~~~~~~~~~~~~~~~~

MAJA respect the Interface detailed in [AD01]_.

Among these interfaces, there are:

-  The « JobOrder »,

-  The « Logging »,

-  The « ExitCode »,

   The log messages are displayed in the standard output.

   The error messages are displayed in the standard error output.

   For additional details on these interfaces see :ref:`operating_manual:operating manual` .

Revisit improvement via sensors mixing
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

MAJA offers the possibility of processing product time series acquired
by different sensors in order to improve the revisit over an area; the
following conditions shall be satisfied:

-  The images to be processed shall have exactly the same footprint

-  The images to be processed shall have the same pixel origin
   convention (center pixel or upper left corner),

-  The coarse resolution chosen for the PRIVATE images of the L2 product
   and for the DEM low resolution images shall be identical for the two
   sensors,

-  The bands selected for the multi-temporal processing and stored in
   the PRIVATE part of L2 product shall be the same for the two sensors
   (see section :ref:`operating_manual:gipp configuration file (gip_l2comm)`),

Note that the bands used for multi-temporal are indicated in GIPP L2COMM
and are used to detect the clouds, shadows, aerosols, etc. Then these
data are used for atmospheric correction of all the bands to process.

The algorithms
--------------

Processing options are defined as a function of sensor in the chain.
Depending on the spectral bands and stereoscopic capabilities of the
satellite, some methods can or cannot be applied to the times series of
the satellite. Table 1 summarizes the main options.

========================== ================================== ================================== ==================================
\                          **Venus**                          **Sentinel2**                      **Landsat8**                      
                                                                                                                                                  
                           **(“muscate” and native formats)** **(“muscate” and native formats)** **(“muscate” and native formats)**
Stereoscopic               X                                                                                                                                
                                                                                                                                                            
cloud detection                                                                                                                                              
Water vapour determination X                                  X                                                                                  
Snow detection                                                X                                  X                                 
Cirrus flag                X                                                                                                                               
Cirrus mask                                                   X                                  X                                          
Snow mask                  X                                  X                                  X                                          
========================== ================================== ================================== ==================================


The products
------------

**General information on Level-2 products**

In Level-2 products:

- Water Vapour data is expressed in g/cm2

- Atmospheric Optical Thickness is dimensionless.

The Scale factors can be found in the main HDR in “Quantification_value”
tags.

It should be noted that the LTC plan (Luts of Top Of Canopy reflectance)
are not consistent in the output L2 product. It depends on the method
used to estimate the aerosol optical thickness. If the processed method
is multi spectral, only the current date is used and the LTC set in the
composite products are not necessary. Therefore, a composite product
generated with the multi spectral method could not be reused to process
a L1 product with another method.

Some clarification should be made to the STO file stored in the private
part of the L2 product. The “STO.DBL.DIR” file contains the TOA
reflectance images after correction for absorbing atmospheric molecules
for a given spectral band (“Correl_Band_Code” parameter set in the
GIP_L2COMM file) and for a maximum number of dates
(“Number_Of_Stack_Images” parameter set also in the GIP_L2COMM). In this
file, the images are stacked as follows:

Band 1 = D (date of the current product)

   Band 2 = D+1

   Band 3 = D+2

   ...

Band 10 = D+9

In the “STO.HDR” file, the list of dates is stored in the
“List_of_Bands” tag:

   <Band sn="1">20130719</Band> => date D

   <Band sn="2">20130703</Band> => date D+1

   ...

<Band sn="10">20130905</Band> => date D+9

Therefore the current date is added at the top of the stack (band 1),
the other dates shift back and the oldest date stored in the STO file
(which is the most recent date in backward mode) is removed (for
instance the 11\ :sup:`th` date if the STO file contained yet 10 dates).

**Peculiarities on Level-2 products depending on the algorithms:**

In line with Table 1, Level-2 products have slight differences due to
slightly different algorithms applied to the input data:

-  Venus Level-2 product is the only one providing the cloud altitude
   image because is the only sensor for which stereoscopy method in
   cloud masking can be applied;

-  Cirrus mask is provided exclusively in Landsat8 and Sentinel-2
   products

-  Snow mask is provided Landsat 8, Sentinel-2 and Venus format
   products

-  The quality mask indicating if water vapor mask has been estimated or
   interpolated is provided exclusively in Venus and Sentinel-2
   products.

**Validity of the Level-2 product:**

A Level-2 product is declared **valid** (flag L2VALD) when:

-  The input Level-1 product is not too cloudy\* and is not contains too
   many ‘no_data’ pixels*\*

-  In nominal mode, the input Level-2 product is not too cloudy*,

-  The output Level-2 product computed is not contains too many
   ‘no_data’ pixels

In the backward mode, the Level-2 product is declared valid if at least
one of the Level-2 product of the series is determined as valid (the
above conditions do not apply).

**\*** A product is identified as too cloudy when the number of cloudy
pixel is upper than the “Max_Cloud_Percentage” (parameter set in the
GIP_L2COMM). Note that the ’no_data’ pixels are excluded to compute this
rate.

**\*\*** A product contains too many ‘no_data’ pixels when the number
‘no_data’ pixels is upper than the “Max_No_Data_percentage” parameters
(parameter set in the GIP_L2COMM).

.. image:: ./Art/BackWardNonValid.png


In **backward** mode, MAJA:

1. **find the first valid L2 product (init mode)**: MAJA ingests the
   first T0+5 product, but it’s detected as non valid (conditions of
   validity are described before) and it’s excluded. The following T0+4
   product is ingested and detected as valid,

2. **processes the series (nominal mode):** produces all previous
   intermediate L2 products, each non valid product are skipped. The
   T0+3 is computed, the T0+2 is ingested but excluded (non valid) and
   the T0+1 is computed,

3. **processes the final L2 product (nominal mode):** MAJA ingests the
   T0 product but it’s detected as non valid and excluded. In this way,
   the latest final product computed in the series is the T0+1 and the
   date of this product is modified and set to T0.

Venus Image products
~~~~~~~~~~~~~~~~~~~~

This section details the content of each Venus product (see [RD02]_).

Level 1 product content
^^^^^^^^^^^^^^^^^^^^^^^

.. image:: ./Art/Venus_L1.png

The Venus L1 product conforms to the VENuS ICD.

Level 2 product content
^^^^^^^^^^^^^^^^^^^^^^^

.. image:: ./Art/Venus_L2.png

The scale factors of each plan (SRE, FRE, ATB, etc.) are contained in
the associated header (.HDR) (e.g. xml tags
Reflectance_Quantification_Value or AOT_Quantification_Value). In order
to optimize the size of the L2 product, some quality masks are
concatenated in a unique file in which each bit is associated to a
specific mask.

For instance, the cloud and cloud shadow mask at full resolution
contains multiple binary masks for each pixel of the image. See the (*)
in the previous Table for the description of the CLD bits.

For example, the value 19 (10011) means that the pixel is a cloudy pixel
detected by the reflectance threshold algorithm.

Sentinel 2 Image products
~~~~~~~~~~~~~~~~~~~~~~~~~

The Sentinel2 L1 GPP product conforms with the GS2 ICD (see [RD03]_).
This section details the content of Level 2 Sentinel 2 product.

The chain allows to mix Sentinel 2A and Sentinel 2B products in nominal
and backward modes.

.. image:: ./Art/Sentinel2_L2.png

Table 5: Level 2 Sentinel 2 Image product

A TIF file is created per data (SRE, FRE, ATB, …) and per resolution (10
and 20 meters).

The scale factors are provided in the global header of the level 2
product (e.g. in the <Reflectance_Quantification_Value> tag so BOA
reflectance = X \* 0.001).

The Landsat L8 Image products
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Level 1 product content
^^^^^^^^^^^^^^^^^^^^^^^

The LANDSAT8 L1 product conforms with the specification contained in the
document [RD04]_.

The directory of a LANDSAT8 L1 product contains an image header file and
a geoTIF file but also a subdirectory MASK that contains the mask of
saturated pixels.

.. image:: ./Art/Landsat8_L1.png

Level 2 product content
^^^^^^^^^^^^^^^^^^^^^^^

The structure of LANDSAT8 and VENUS level 2 products is nearly the same.
The differences are found in the number of spectral bands and the
resolution of images. The cirrus mask is added to the cloud mask. The
level 2 product does not contain angle grids.

.. image:: ./Art/Landsat8_L2.png


The Landsat L8 “MUSCATE” Image products 
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The LANDSAT 8 L1 and L2 products conform with the specifications
contained in the document [RD05]_.

The Landsat L8 “native” Image products 
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Landsat L8 level 1 product content
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

The LANDSAT 8 L1 products conform with the specifications contained in
the document [RD07]_.

Landsat L8 level 2 product content
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

The structure of the level 2 products is described in the previous
section :ref:`user_manual:landsat l8 level 1 product content`.

The Sentinel2 “native” Image products 
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Level 1 product content
^^^^^^^^^^^^^^^^^^^^^^^

The Sentinel2 L1 products conform with the specifications contained in
the document [RD06]_.

Level 2 product content
^^^^^^^^^^^^^^^^^^^^^^^

The Level 2 Sentinel 2 native product is described in the previous
section :ref:`user_manual:sentinel 2 image products`.

The Sentinel2 “MUSCATE” Image products 
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The Sentinel2 L1 and L2 products conform with the specifications
contained in the document [RD05]_.

The Venus “MUSCATE” Image products 
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The Venus L1 and L2 products conform with the specifications contained
in the document [RD05]_.

Auxiliary data of MAJA
----------------------

============================== ======================================================================================================================================================================
**File**                       **Comment**
XXX_EXO_METDTA_XXX (HDR + DBL) Archive that contains the ozone image.
                              
                               | In the MAJAUserConfig_<MISSION>.xml, if the value of the “Use_Default_Constant_Ozone_Amount” field is false, the input data EXO_METDTA is mandatory.
                               | If it’s true, the default constant ozone value used is the value set in “Atmospheric_Absorption_Correction/Ozone_Amount_Default_Value” field in the GIP_L2COMM file.
XXX_EXO_CAMS_XXX (HDR + DBL)   Archive that contains the CAMS data.
                              
                               | In the GIP_L2COMM file, if the value of the “Use_Cams_Data” field is true, the input datas EXO_CAMS will be parsed to find suitable CAMS data for the product.
                               | If it is false or not suitable for the product the CONSTANT_Model from the GIPP L2COMM File will be used instead.
XXX_AUX_REFDE2_XXX (HDR + DBL) DEM Archive that contains:
                              
                               -  The altitude image: ALT
                              
                               -  The altitude image at L2 coarse resolution: ALC
                              
                               -  The aspect image at L2 resolution: ASP
                              
                               -  The aspect image at L2 coarse resolution: ASC
                              
                               -  The slope image at L2 resolution: SLP
                              
                               -  The slope image at L2 coarse resolution: SLC
                              
                               -  The water mask: MSK
                              
                                  All these files have exactly the same footprint of the Level-1 product to process.
============================== ======================================================================================================================================================================

Please note the particular case of SENTINEL2 where the output Level 2
product contains two resolutions (R1 = 10m and R2= 20m) depending on the
spectral band. In this case, the images of the altitude (ALT), the
aspect (ASP) and the slope (SLP) are provided with the two resolutions
R1 and R2 (e.g: \_ALT_R1.tif and \_ALT_R2.tif).

By default the constant model will be used for the various LUT ( TOCR,
ALBD, DIRT, DIFT). However these luts have been computed using an
average model of atmosphere composition. In order to be more precise the
CAMS data can be used to establish the exact proportions of each model
according to the product localisation and time. To enable this you have
to turn on the Use_Cams_Data field in the L2COMM Gipp and provide:

-  At least one CAMS file (.HDR +.DBL) acquired in the range
   [Product_time – time_windows][Product_time+time_windows]. The
   time_windows is a parameter in the L2COMM GIPPP.

-  LUTS for each selected model in the Model_List node of L2COMM : TOCR,
   DIRT, DIFT and ALBD. Please note that the TOCR luts for CAMS models
   have some information added in the HDR compared to a constant lut,
   see example provided in the install folder.

The current CAMS format provided by Copernicus contains data for Dust,
Seasalt, Organic Matter, Black Carbon and Sulphate. Each model
proportion is then associated with it’s own lut to compute the final LUT
used in the processing. If no suitable CAMS are found for a given
product then the constant model will be used.The unit of the ozone
content is Kg.m\ :sup:`-2` but to be conformed with SMAC and 6S this
content is converted to cm.atm.m\ :sup:`-2`. The conversion from
kg.m\ :sup:`-2` to cm.atm.m\ :sup:`-2` is:

1 Dobson Unit (DU) is:

2.6867 x 1020 mol.m\ :sup:`-2`

4.4615 x 10-4 mol.m\ :sup:`-2`

2.1416 x 10-5 Kg[O3].m\ :sup:`-2`

1 Kg.m\ :sup:`-2` = 46694 Dobson

1 cm.atm.m\ :sup:`-2` = 1000 dobson = 1 Jacobson

1 Kg.m\ :sup:`-2` = 46.694 cm.atm.m\ :sup:`-2`

If the meteo data is not available, a default value is set in the
GIP_L2COMM file. Its unit is cm.atm.m\ :sup:`-2`.

Generally, the ozone content varies between 250 and 480 Dobson (0,25 and
0,48 cm.atm.m\ :sup:`-2`). By default the value is set to 0,3
cm.atm.m\ :sup:`-2`.The meteo data are detected in the chain with their
“EXO_METDTA” keyword. The “Mission” field set in the header (.HDR) of
the meteo data is not used.

-  In Init and Nominal modes, only one file is required in the input
   directory otherwise an error is raised. In those cases, the validity
   dates are not read by MAJA.

-  In backward mode, one meteo data should be available for each
   processed L1 product. For each L1 product, the chain looks for the
   associated meteo data and checks if the product date is included in
   the validity “start” and “stop” dates of this meteo data.

GIPPs files of MAJA
-------------------

The GIPP files used in MAJA are listed in the following table.


==================================== =================================================================================================================================================
**File**                             **Comment**
**L2**    
XXX_GIP_L2COMM_XXX.EEF               Contains all the L2/L3 common parameters.
XXX_GIP_L2TOCR_XXX.HDR (+ .DBL)      Contains the LUT of Canopy reflectance.
                                    
                                     | One for the constant model in the L2COMM Gipp file and one for each CAMS model in the Model_List of L2COMM if this functionality is activated.
				     | In case of model LUT for CAMS usage some additional datas have to be put in the HDR like the extinctionCoeffs ( see examples).
XXX_GIP_L2DIRT_XXX.HDR (+ .DBL)      Contains the LUT of Direct Transmission.
                                    
                                     | One for the constant model in the L2COMM Gipp file and one for each CAMS model in the Model_List of L2COMM if this functionality is activated.
XXX_GIP_L2DIFT_XXX.HDR (+ .DBL)      Contains the LUT of Diffuse Transmission.
                                    
                                     | One for the constant model in the L2COMM Gipp file and one for each CAMS model in the Model_List of L2COMM if this functionality is activated.
XXX_GIP_L2ALBD_XXX.HDR (+ .DBL)      Contains the LUT of Atmospheric Albedo.
                                    
                                     | One for the constant model in the L2COMM Gipp file and one for each CAMS model in the Model_List of L2COMM if this functionality is activated.
XXX_GIP_L2WATV_XXX.HDR (+ .DBL)      Contains the LUT of Water Vapor.
XXX_GIP_L2SMAC_XXX.EEF               Contains the SMAC coefficients.
XXX_GIP_L2SITE_XXX_<SITE>.EEF        Contains the site parameters.
==================================== =================================================================================================================================================

Notes:

-  Parameter definitions are set as html comments in the xml file,

-  The specific checking tools parameters are precisely described (as
   html comments) in the GIPPs “CKQLT” and “CKEXTL” xml files. To
   disable (or enable) the generation of the quicklooks, set the value
   of the field “Compute_QL” to false (or true) in the CKQLTL GIP file.
   In the same way, to disable (or enable) the generation of the
   extracts points, set the value of the field “Compute_Extract_Points”
   to false (or true) in the CKEXTL file,

-  More instances examples of these files as installed in the
   “../share/examples” directory

-  Contrary to the meteo data, the “Mission » field is read in the GIPPs
   in order to detect which GIPP is associated to the processed L1
   product (because of the mixing of sensors). On the other hand, the
   validity dates are not considered

